#!/bin/bash
# Tmux Theme FSWatch
# Uses fswatch to monitor system preferences changes

PREFS_FILE="$HOME/Library/Preferences/.GlobalPreferences.plist"
LOG_FILE="$HOME/.local/log/tmux-theme-fswatch.log"

# Create log directory if it doesn't exist
mkdir -p "$(dirname "$LOG_FILE")"

reload_tmux_if_theme_changed() {
    echo "$(date): System preferences changed, checking theme..." >> "$LOG_FILE"
    
    # Small delay to ensure the preference is written
    sleep 0.5
    
    # Check if tmux is running
    if command -v tmux >/dev/null && tmux list-sessions >/dev/null 2>&1; then
        echo "$(date): Reloading tmux config..." >> "$LOG_FILE"
        tmux source-file ~/.tmux.conf
        echo "$(date): Tmux config reloaded" >> "$LOG_FILE"
    else
        echo "$(date): No tmux sessions running" >> "$LOG_FILE"
    fi
}

# Check if fswatch is available
if ! command -v fswatch >/dev/null; then
    echo "$(date): fswatch not found. Install with: brew install fswatch" >> "$LOG_FILE"
    exit 1
fi

echo "$(date): Starting tmux theme fswatch monitor..." >> "$LOG_FILE"

# Monitor the global preferences file for changes
fswatch -o "$PREFS_FILE" | while read -r num; do
    reload_tmux_if_theme_changed
done